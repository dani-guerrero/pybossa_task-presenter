<div class="container">
<div class="row">
    <!-- Success and Error Messages for the user --> 
    <div class="col-md-6 col-md-offset-2" style="height:50px">
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            <strong id="i18n_welldone">Well done!</strong> <span id="i18n_welldone_text">Your answer has been saved</span>
        </div>
        <div id="loading" class="alert alert-info" style="display:none;">
            <a class="close">×</a>
            <span id="i18n_loading_next_task">Loading next task...</span>
        </div>
        <div id="taskcompleted" class="alert alert-info" style="display:none;">
            <strong id="i18n_task_completed">The task has been completed!</strong> <span id="i18n_thanks">Thanks a lot!</span>
        </div>
        <div id="finish" class="alert alert-success" style="display:none;">
            <strong id="i18n_congratulations">Congratulations!</strong> <span id="i18n_congratulations_text">You have participated in all available tasks!</span>
            <br/>
            <div class="alert-actions">
                <a class="btn small" href="/">Go back</a>
                <a class="btn small" href="/app">or, Check other projects</a>
            </div>
        </div>
        <div id="error" class="alert alert-danger" style="display:none;">
            <a class="close">×</a>
            <strong>Error!</strong> Something went wrong, please contact the site administrators
        </div>
    </div> <!-- End Success and Error Messages for the user -->
</div> <!-- End of Row -->

<!--
    Task DOM for loading the Flickr Images
    It uses the class="skeleton" to identify the elements that belong to the
    task.
-->
<div class="row skeleton"> <!-- Start Skeleton Row-->
    <div class="col-md-6 "><!-- Start of Question and Submission DIV (column) -->
        <h1 id="question"><span id="i18n_question">Do you see a human face in this photo?</span></h1> <!-- The question will be loaded here -->
        <div id="answer"> <!-- Start DIV for the submission buttons -->
            <!-- If the user clicks this button, the saved answer will be value="yes"-->
            <button class="btn btn-success btn-answer" value='yes'><i class="fa fa-thumbs-o-up"></i> <span id="i18n_yes">Yes</span></button>
            <!-- If the user clicks this button, the saved answer will be value="no"-->
            <button class="btn btn-danger btn-answer" value='no'><i class="fa fa-thumbs-o-down"></i> No</button>
            <!-- If the user clicks this button, the saved answer will be value="NotKnown"-->
            <button class="btn btn-answer" value='NotKnown'><i class="fa fa-question-circle"></i> <span id="i18n_i_dont_know">I don't know</span></button>
        </div><!-- End of DIV for the submission buttons -->
        <!-- Feedback items for the user -->
        <p><span id="i18n_working_task">You are working now on task:</span> <span id="task-id" class="label label-warning">#</span></p>
        <!-- <p><span id="i18n_tasks_completed">You have completed:</span> <span id="done" class="label label-info"></span> <span id="i18n_tasks_from">tasks from</span>
        Progress bar for the user
        <span id="total" class="label label-info"></span></p>
        <div class="progress progress-striped">
            <div id="progress" rel="tooltip" title="#" class="progress-bar" style="width: 0%;"  role="progressbar"></div>
        </div> -->
        <!-- 
            This application uses Disqus to allow users to provide some feedback.
            The next section includes a button that when a user clicks on it will
            load the comments, if any, for the given task
        -->
        <!-- Disqus thread for the given task -->
        <div id="disqus_thread" style="margin-top:5px;display:none"></div>
    </div><!-- End of Question and Submission DIV (column) -->
    <div class="col-md-6"><!-- Start of Photo DIV (column) -->
        <a id="photo-link" href="#">
            <img id="photo" src="http://i.imgur.com/GeHxzb7.png" style="max-width=100%">
        </a>

    </div><!-- End of Photo DIV (columnt) -->
</div><!-- End of Skeleton Row -->
</div>

<script>
// Default language
var userLocale = "en";
var html_answers = {}
// Translations


var messages = {
    "en": {
                        "i18n_welldone": "Well done!",
                        "i18n_welldone_text": "Your answer has been saved",
                        "i18n_loading_next_task": "Loading next task...",
                        "i18n_task_completed": "The task has been completed!",
                        "i18n_thanks": "Thanks a lot!",
                        "i18n_congratulations": "Congratulations",
                        "i18n_congratulations_text": "You have participated in all available tasks!",
                        "i18n_yes": "Yes",
                        "i18n_no_photo": "No photo",
                        "i18n_i_dont_know": "I don't know",
                        "i18n_working_task": "You are working now on task:",
                        "i18n_tasks_completed": "You have completed:",
                        "i18n_tasks_from": "tasks from",
                        "i18n_show_comments": "Show comments:",
                        "i18n_hide_comments": "Hide comments:",
                        "i18n_first_question": "Do you see a mosquito in this photo?",
                        "i18n_which_mosquito": "Could you identify what kind of mosquito is?",
                        "i18n_which_torax": "Are you able to recognize its torax?",
                        "i18n_which_legs": "Can you see how the third pair (rear) legs look?",
                        "i18n_breeding_site": "Can you see a place where mosquitoes could breed?",
                        "i18n_breeding_water": "Can you see if the site contains water?",
                        "i18n_breeding_larvae": "Can you see mosquito larvae?",
                        "i18n_aedes": "Invasor aedes",
                        "i18n_culex" : "Culex common mosquito",
                        "i18n_albopictus": "Aedes albopictus",
                        "i18n_aegypti": "Aedes aegypti",
                        "i18n_japonicus_koreicus": "Aedes japonicus/koreicus",
                        "i18n_japonicus": "Aedes japonicus",
                        "i18n_koreicus": "Aedes koreicus",
                        "i18n_any": "Any of them",
                        "i18n_report": "Report abuse",
                      },

                "es": {
                        "i18n_welldone": "Bien hecho!",
                        "i18n_welldone_text": "Tu respuesta ha sido guardada",
                        "i18n_loading_next_task": "Cargando la siguiente tarea...",
                        "i18n_task_completed": "La tarea ha sido completadas!",
                        "i18n_thanks": "Muchísimas gracias!",
                        "i18n_congratulations": "Enhorabuena",
                        "i18n_congratulations_text": "Has participado en todas las tareas disponibles!",
                        "i18n_yes": "Sí",
                        "i18n_no_photo": "No hay foto",
                        "i18n_i_dont_know": "No lo sé",
                        "i18n_working_task": "Estás trabajando en la tarea:",
                        "i18n_tasks_completed": "Has completado:",
                        "i18n_tasks_from": "tareas de",
                        "i18n_show_comments": "Mostrar comentarios",
                        "i18n_hide_comments": "Ocultar comentarios",
                        "i18n_question": "¿Ves una cara humana en esta foto?",
                      },
               };

var question_flow = {
    "root": {
        "question": messages[userLocale]["i18n_first_question"],
        "answers": "default",
        "branch":{
            "yes": {
                "question":messages[userLocale]["i18n_which_mosquito"],
                "answers": "mosquito_answers",
                "branch":{
                    "aedes":{
                        "question":messages[userLocale]["i18n_which_torax"],
                        "answers": "torax_answers",
                        "branch":{
                            "japonicus_koreicus": {
                                "question":messages[userLocale]["i18n_which_legs"],
                                "answers": "legs_answers"
                            }
                        }
                    }
                }
            },
            "no":{
                "question":messages[userLocale]["i18n_breeding_site"],
                "answers": "default",
                "branch":{
                    "yes":{
                        "question":messages[userLocale]["i18n_breeding_water"],
                        "answers": "default",
                        "branch": {
                            "yes":{
                                "question":messages[userLocale]["i18n_breeding_larvae"],
                                "answers": "default"
                            }
                        }
                    }
                }
            }
        }
    }
}
 var current_question = question_flow["root"];
// Update userLocale with server side information
 $(document).ready(function(){
    userLocale = document.getElementById('PYBOSSA_USER_LOCALE').textContent.trim();
    html_answers = 
       {   
           "default":
            `<button class="btn btn-success btn-answer" value='yes'><i class="fa fa-thumbs-o-up"></i> <span id="i18n_yes">Yes</span></button>
            <button class="btn btn-danger btn-answer" value='no'><i class="fa fa-thumbs-o-down"></i> No</button>
            <button class="btn btn-answer" value='NotKnown_mosquito_presence'><i class="fa fa-question-circle"></i> <span id="i18n_i_dont_know">I don't know</span></button>`,
           "mosquito_answers":
               `<button class="btn btn-dark btn-answer" value='aedes'> ${messages[userLocale]["i18n_aedes"]}</button>
               <button class="btn btn-info btn-answer" value='culex'>${messages[userLocale]["i18n_culex"]} </button>
               <button class="btn btn-answer" value='NotKnown_which_mosquito'><i class="fa fa-question-circle"></i> ${messages[userLocale]["i18n_i_dont_know"]}"</button>
               <button class="btn btn-warning btn-answer" value='any_mosquito'><i class="fa fa-thumbs-o-down"></i> ${messages[userLocale]["i18n_any"]}</button>`,
           "torax_answers":
               `<button class="btn btn-dark btn-answer" value='albopictus'> ${messages[userLocale]["i18n_albopictus"]}</button>
               <button class="btn btn-info btn-answer" value='aegypti'>${messages[userLocale]["i18n_aegypti"]} </button>
               <button class="btn btn-info btn-answer" value='japonicus_koreicus'>${messages[userLocale]["i18n_japonicus_koreicus"]} </button>
               <button class="btn btn-answer" value='NotKnown_torax'></i> ${messages[userLocale]["i18n_i_dont_know"]}"</button>
               <button class="btn btn-warning btn-answer" value='any_torax'><i class="fa fa-thumbs-o-down"></i> ${messages[userLocale]["i18n_any"]}</button>`,
           "legs_answers":
               `<button class="btn btn-dark btn-answer" value='japonicus'> ${messages[userLocale]["i18n_japonicus"]}</button>
               <button class="btn btn-info btn-answer" value='koreicus'>${messages[userLocale]["i18n_koreicus"]} </button>
               <button class="btn btn-answer" value='NotKnown_legs'><i class="fa fa-question-circle"></i> ${messages[userLocale]["i18n_i_dont_know"]}"</button>`,
           "breeding_answers":
               `<button class="btn btn-dark btn-answer" value='yes'><i class="fa fa-thumbs-o-up"></i> ${messages[userLocale]["i18n_yes"]}</button>
               <button class="btn btn-info btn-answer" value='no_breeding'><i class="fa fa-thumbs-o-down"></i>${messages[userLocale]["i18n_no"]} </button>
               <button class="btn btn-answer" value='NotKnown_breeding'><i class="fa fa-question-circle"></i> ${messages[userLocale]["i18n_i_dont_know"]}"</button>`,
           "water_answers":
               `<button class="btn btn-dark btn-answer" value='yes'><i class="fa fa-thumbs-o-up"></i> ${messages[userLocale]["i18n_yes"]}</button>
               <button class="btn btn-info btn-answer" value='no_water'><i class="fa fa-thumbs-o-down"></i>${messages[userLocale]["i18n_no"]} </button>
               <button class="btn btn-answer" value='NotKnown_water'><i class="fa fa-question-circle"></i> ${messages[userLocale]["i18n_i_dont_know"]}"</button>`,
           "larvae_answers":
               `<button class="btn btn-dark btn-answer" value='yes_larvae'><i class="fa fa-thumbs-o-up"></i> ${messages[userLocale]["i18n_yes"]}</button>
               <button class="btn btn-info btn-answer" value='no_larvae'><i class="fa fa-thumbs-o-down"></i>${messages[userLocale]["i18n_no"]} </button>
               <button class="btn btn-answer" value='NotKnown_larvae'><i class="fa fa-question-circle"></i> ${messages[userLocale]["i18n_i_dont_know"]}"</button>`
       }

});

function i18n_translate() {
    var ids = Object.keys(messages[userLocale])
    for (i=0; i<ids.length; i++) {
        if($(`#${ids[i]}`).length > 0){
            console.log("Translating: " + ids[i]);
            document.getElementById(ids[i]).innerHTML = messages[userLocale][ids[i]];
        }
    }
}


function loadUserProgress() {
    pybossa.userProgress('mosquito-surveys').done(function(data){
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'left'}); 
        $("#total").text(data.total);
        $("#done").text(data.done);
    });
}

pybossa.taskLoaded(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        var img = $('<img />');
        img.load(function() {
            // continue as soon as the image is loaded
            deferred.resolve(task);
        });
        img.attr('src','http://webserver.mosquitoalert.com/media/'+task.info.photo).css('height', 460);
        img.addClass('img-thumbnail img-responsive');
        task.info.image = img;
    }
    else {
        deferred.resolve(task);
    }
});

function next_question(answer){
    current_question = current_question["branch"][answer];
    $("#question").html(current_question["question"]);
    $("#answer").html(html_answers[current_question["answers"]]);
}

function reset_current_question(){
    current_question = question_flow["root"]
    $("#question").html(current_question["question"]);
    $("#answer").html(html_answers[current_question["answers"]]);
}

function task_completed(answer){
    if (!("branch" in current_question && answer in current_question["branch"]))
        return true

    return false 
}

function set_buttons_function(task, deferred){
    $('.btn-answer').off('click').on('click', function(evt) {
        console.log('clicked')
        var answer = $(this).attr("value");
        if (typeof answer != 'undefined') {
            if (!task_completed(answer)){
                next_question(answer);
                set_buttons_function(task,deferred,answer)
            }
            else{
                reset_current_question()
                pybossa.saveTask(task.id, answer).done(function() {
                    deferred.resolve();
                });
                $("#loading").fadeIn(100);
                $("#loading").fadeOut(1000);
                if ($("#disqus_thread").is(":visible")) {
                    $('#disqus_thread').toggle();
                    $('.btn-disqus').toggle();
                }
            }
        }
        else {
            $("#error").show();
        }
    });
}

pybossa.presentTask(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        loadUserProgress();
        i18n_translate();
        $('#photo-link').html('').append(task.info.image);
        $("#photo-link").attr("href", task.info.link);
        $("#question").html(current_question["question"]);
        $('#task-id').html(task.id);
        set_buttons_function(task,deferred,answer)
        $("#loading").hide();
    }
    else {
        $(".skeleton").hide();
        $("#loading").hide();
        $("#finish").fadeIn(500);
    }
});


pybossa.run('mosquito-surveys');
</script>
